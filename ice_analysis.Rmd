---
title: "ice_analysis"
author: "Christopher Rounds"
date: "3/30/2022"
output: html_document
---

```{r setup, include=FALSE}
library(lme4)
library(MuMIn)
library(effects)
library(mgcv)
library(gratia)
library(gamm4)
library(itsadug)
library(tidyverse)


duration_spatial <- read.csv("./data/cleaned/duration_spatial.csv")
icein_spatial <- read.csv("./data/cleaned/ice_in_spatial.csv")
iceout_spatial <- read.csv("./data/cleaned/ice_out_spatial.csv")


```


```{r duration}
observations <- duration_spatial %>%
  group_by(DOW) %>%
  count() %>%
  dplyr::filter(n >= 5)

length(unique(observations$DOW))
sum(observations$n)

observations <- duration_spatial %>%
  filter(year_in > 1948) %>%
  group_by(DOW) %>%
  count() %>%
  dplyr::filter(n >= 5)

length(unique(observations$DOW))
sum(observations$n)

observations <- duration_spatial %>%
  filter(year_in > 1948) %>%
  subset(!is.na(max_depth)) %>%
  group_by(DOW) %>%
  count() %>%
  dplyr::filter(n >= 3)

length(unique(observations$DOW))
sum(observations$n)

```

```{r map}
states <- map_data("state")
counties <- map_data("county")
minnesota <- subset(states, region %in% c("minnesota"))

ggplot() +
  geom_polygon(data = minnesota, mapping = aes(x = long, y = lat, group = group),
               color = "black", fill = "gray") +
  coord_fixed(1.3) +
  geom_point(data = duration_spatial, aes(x = long, y = lat), alpha = 0.25) +
  coord_cartesian() +   
  labs(title = "Spatial Scatterplot of lakes",
       x = "Latitude",
       y = "Longitude")
```
```{r}
plot_lake <- function(input_DOW){
  ice_data %>%
    dplyr::filter(DOW == input_DOW) %>%
    ggplot(aes(x = winter_year, y = duration)) +
    geom_point() +
    geom_smooth(method = 'lm', se = TRUE) +
    theme(legend.position = "none")
}

plot_lake("31055400")
```


```{r duration}
duration_model_df <- duration_spatial %>%
  filter(DOW %in% observations$DOW) %>%
  filter(year_out > 1947) %>%
  mutate(DOW = as.factor(DOW),
         DOW_CDOM_Ecoregion = as.factor(DOW_CDOM_Ecoregion),
         log_acres = log(acres))

duration_lm <- lm(duration ~ winter_year + log_acres + shore_mi + max_depth + 
           ENSO + QBO + SUN + ENSOw + QBOw + SUNw, data = duration_model_df)
summary(duration_lm)

duration_re <- lmer(duration ~ winter_year + log_acres + log(shore_mi) + max_depth + 
           ENSO + QBO + SUN + ENSOw + QBOw + SUNw + (1|DOW), data = duration_model_df)
summary(duration_re)
r.squaredGLMM(duration_re)
#plot(allEffects(duration_re, partial.residuals = TRUE))
```


```{r}
gam_duration <- mgcv::bam(duration ~ s(winter_year, k=4)  + s(DOW, bs = 're') + 
                                              s(log_acres, k=3) +
                                              s(ENSOw, k=3) + s(QBOw, k=3) +
                                              s(SUNw, k=3),
                                            data = duration_model_df,
                                            select = TRUE)
summary(gam_duration)
draw(gam_duration)
deriv_ex <- derivatives(gam_duration, term = "winter_year", interval = "simultaneous", partial_match = TRUE)

year_seq <- seq(from = 1948,
                to = 2021,
                by = 1)
ci_trend <- confint(gam_duration, type = 'simultaneous', parm = "s(winter_year)", 
                    partial_match = TRUE)

ggplot(data = ci_trend,
       aes(x = winter_year, y = est)) + 
  geom_hline(yintercept = 0, col = 'grey') +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) + 
  geom_line() + 
  scale_y_continuous(name = "Statewide trend\n(days from long-term average cover)") + 
  theme_classic() + theme(axis.title.x = element_blank())

ggplot(data = deriv_ex,
       aes(x = data, y = derivative)) + 
  geom_hline(yintercept = 0, col = 'grey') +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) + 
  geom_line() +
  scale_y_continuous(name = "Statewide rate of change\n(days/year)") + 
  theme_classic() + theme(axis.title.x = element_blank())
```


